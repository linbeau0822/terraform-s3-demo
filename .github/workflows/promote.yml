name: Promote site between environments

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Promotion target: qa or prod'
        required: true
        default: 'qa'
      aws_region:
        description: 'AWS region'
        required: true
        default: 'us-east-1'

jobs:
  promote:
    name: Promote site (qa or prod)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set bucket variables
        id: set-vars
        run: |
          set -euo pipefail
          TARGET="${{ github.event.inputs.target }}"
          echo "Determining source/destination buckets for target: $TARGET"
          if [ "$TARGET" = "qa" ]; then
            echo "SRC_BUCKET=my-unique-bucket-name-28812409-dev" >> $GITHUB_OUTPUT
            echo "DST_BUCKET=my-unique-bucket-name-28812409-qa" >> $GITHUB_OUTPUT
            echo "SRC_KEY=index-dev.html" >> $GITHUB_OUTPUT
            echo "DST_KEY=index-qa.html" >> $GITHUB_OUTPUT
            echo "DST_ENV=qa" >> $GITHUB_OUTPUT
          elif [ "$TARGET" = "prod" ]; then
            echo "SRC_BUCKET=my-unique-bucket-name-28812409-qa" >> $GITHUB_OUTPUT
            echo "DST_BUCKET=my-unique-bucket-name-28812409-prod" >> $GITHUB_OUTPUT
            echo "SRC_KEY=index-qa.html" >> $GITHUB_OUTPUT
            echo "DST_KEY=index-prod.html" >> $GITHUB_OUTPUT
            echo "DST_ENV=prod" >> $GITHUB_OUTPUT
          else
            echo "Invalid target: $TARGET (must be 'qa' or 'prod')" >&2
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.inputs.aws_region }}

      - name: Copy object between buckets
        run: |
          set -euo pipefail
          SRC_BUCKET="${{ steps.set-vars.outputs.SRC_BUCKET }}"
          DST_BUCKET="${{ steps.set-vars.outputs.DST_BUCKET }}"
          SRC_KEY="${{ steps.set-vars.outputs.SRC_KEY }}"
          DST_KEY="${{ steps.set-vars.outputs.DST_KEY }}"
          echo "Copying s3://$SRC_BUCKET/$SRC_KEY -> s3://$DST_BUCKET/$DST_KEY"
          aws s3 cp "s3://$SRC_BUCKET/$SRC_KEY" "s3://$DST_BUCKET/$DST_KEY" --acl public-read --metadata-directive REPLACE
        env:
          AWS_REGION: ${{ github.event.inputs.aws_region }}

      - name: Invalidate CloudFront for destination (if present)
        run: |
          set -euo pipefail
          DST_BUCKET="${{ steps.set-vars.outputs.DST_BUCKET }}"
          DST_KEY="${{ steps.set-vars.outputs.DST_KEY }}"
          echo "Looking up CloudFront distribution for bucket: $DST_BUCKET"
          DIST_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?contains(Origins.Items[0].DomainName, '$DST_BUCKET')].Id" \
            --output text)
          if [ -z "$DIST_ID" ]; then
            echo "No CloudFront distribution found for bucket '$DST_BUCKET' - skipping invalidation"
            exit 0
          fi
          echo "Found distribution id: $DIST_ID"
          aws cloudfront create-invalidation --distribution-id "$DIST_ID" --paths "/$DST_KEY"
        env:
          AWS_REGION: ${{ github.event.inputs.aws_region }}
